pipeline {
    agent any

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup virtual Environment') {
            steps {
                script {
                    def scriptPath = "${WORKSPACE}/scripts_new/setup_virtualenv.sh"
                    if (fileExists(scriptPath)) {
                        sh "chmod +x ${scriptPath}"
                        sh "./${scriptPath}"
                    } else {
                        error "Script setup_virtualenv.sh not found at ${scriptPath}"
                    }
                }
            }
        }
        
        stage ('Setup Environment') {
            steps {
                sh'''
                chmod +x scripts_new/env_setup.sh
                chmod +x scripts_new/check_env.sh
                ./scripts_new/env_setup.sh
                '''
            }
        }
        
        stage ('Run Migrations') {
            steps {
                sh'''
                chmod +x scripts_new/run_migration.sh
                chmod +x scripts_new/check_env.sh
                ./scripts_new/run_migration.sh
                '''
            }
        }
        
        stage ('Compressing the directory') {
            steps {
                sh'''
                chmod +x scripts_new/zip_folder.sh
                ./scripts_new/zip_folder.sh
                '''
            }
        }
    }
}

// Function to check if file exists
def fileExists(path) {
    return new File(path).exists()
}
